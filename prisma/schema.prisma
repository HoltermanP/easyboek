// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  clerkId   String?  @unique // Clerk user ID
  email     String   @unique
  name      String?
  password  String?  // Optioneel voor toekomstige implementatie
  role      String   @default("user") // "user" | "admin" | "developer"
  isDeveloper Boolean @default(false) // Developer accounts hebben gratis toegang
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  companies    Company[]
  subscription Subscription?
  preferences  UserPreferences?

  @@map("users")
}

model Company {
  id         String   @id @default(cuid())
  ownerId    String
  name       String
  year       Int      @default(2025) // Jaar van de administratie
  kvkNumber  String?
  btwNumber  String?
  hourlyRate Decimal? @db.Decimal(10, 2) // Uurtarief in euro's
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  owner            User                 @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  bookings         Booking[]
  documents        TransactionDocument[]
  invoices         Invoice[]
  customers        Customer[]
  vatPeriods       VatPeriod[]
  ledgerAccounts   LedgerAccount[]
  recurringBookings RecurringBooking[]
  taxRules         TaxRules?
  incomeTaxData    IncomeTaxData?
  timeEntries      TimeEntry[]
  mileageEntries   MileageEntry[]

  @@unique([ownerId, year]) // EÃ©n administratie per jaar per gebruiker
  @@map("companies")
}

model TransactionDocument {
  id             String   @id @default(cuid())
  companyId      String
  url            String
  originalFilename String
  type          String   // "invoice" | "receipt" | "other"
  ocrText       String?
  aiCategory    String?
  status        String   @default("uploaded") // "uploaded" | "processed" | "booked"
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("transaction_documents")
}

model LedgerAccount {
  id        String   @id @default(cuid())
  companyId String
  code      String
  name      String
  type      String   // "balance" | "result"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company           Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  debitBookings     Booking[] @relation("DebitAccount")
  creditBookings    Booking[] @relation("CreditAccount")
  recurringDebitBookings  RecurringBooking[] @relation("RecurringDebitAccount")
  recurringCreditBookings RecurringBooking[] @relation("RecurringCreditAccount")

  @@unique([companyId, code])
  @@map("ledger_accounts")
}

model Booking {
  id              String   @id @default(cuid())
  companyId       String
  date            DateTime
  description     String
  debitAccountId  String
  creditAccountId String
  amount          Decimal  @db.Decimal(10, 2)
  vatCode         String?
  createdBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  company         Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  debitAccount    LedgerAccount @relation("DebitAccount", fields: [debitAccountId], references: [id])
  creditAccount   LedgerAccount @relation("CreditAccount", fields: [creditAccountId], references: [id])

  @@map("bookings")
}

model Customer {
  id          String   @id @default(cuid())
  companyId   String
  name        String
  email       String?
  address     String?
  city        String?
  postalCode  String?
  country     String?  @default("NL")
  kvkNumber   String?
  btwNumber   String?
  hourlyRate  Decimal? @db.Decimal(10, 2) // Standaard uurtarief voor deze klant
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  invoices    Invoice[]
  timeEntries TimeEntry[]

  @@map("customers")
}

model Invoice {
  id          String   @id @default(cuid())
  companyId   String
  customerId String
  number      String
  date        DateTime
  dueDate     DateTime
  items       Json     // Array of { description, quantity, price, vat }
  total       Decimal  @db.Decimal(10, 2)
  vatTotal    Decimal  @db.Decimal(10, 2)
  status      String   @default("draft") // "draft" | "sent" | "paid" | "overdue"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer    Customer @relation(fields: [customerId], references: [id])

  @@unique([companyId, number])
  @@map("invoices")
}

model VatPeriod {
  id        String   @id @default(cuid())
  companyId String
  startDate DateTime
  endDate   DateTime
  status    String   @default("open") // "open" | "ready" | "filed" | "reopened"
  vatAmount Decimal? @db.Decimal(10, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("vat_periods")
}

model RecurringBooking {
  id              String   @id @default(cuid())
  companyId       String
  description     String
  debitAccountId  String
  creditAccountId String
  amount          Decimal  @db.Decimal(10, 2)
  vatCode         String?
  frequency       String   // "monthly" | "quarterly" | "yearly"
  dayOfMonth      Int      // Dag van de maand (1-31)
  startDate       DateTime
  endDate         DateTime? // Optioneel: wanneer stoppen
  isActive        Boolean  @default(true)
  lastProcessed   DateTime? // Laatste keer dat deze is verwerkt
  createdBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  company         Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  debitAccount    LedgerAccount @relation("RecurringDebitAccount", fields: [debitAccountId], references: [id])
  creditAccount   LedgerAccount @relation("RecurringCreditAccount", fields: [creditAccountId], references: [id])

  @@map("recurring_bookings")
}

model TaxRules {
  id              String   @id @default(cuid())
  companyId       String   @unique
  year            Int      // Jaar waarop deze regels van toepassing zijn
  
  // BTW tarieven
  vatStandardRate Decimal  @db.Decimal(5, 2) // Standaard BTW tarief (bijv. 21%)
  vatReducedRate  Decimal  @db.Decimal(5, 2) // Verlaagd BTW tarief (bijv. 9%)
  vatZeroRate     Decimal  @default(0) @db.Decimal(5, 2) // Nul tarief
  
  // Inkomstenbelasting tarieven (voor ZZP)
  incomeTaxRate1  Decimal? @db.Decimal(5, 2) // Eerste schijf
  incomeTaxRate2  Decimal? @db.Decimal(5, 2) // Tweede schijf
  incomeTaxRate3  Decimal? @db.Decimal(5, 2) // Derde schijf
  incomeTaxRate4  Decimal? @db.Decimal(5, 2) // Vierde schijf
  
  // Inkomstenbelasting schijven (in euro's)
  incomeTaxBracket1 Decimal? @db.Decimal(12, 2) // Eerste schijf tot
  incomeTaxBracket2 Decimal? @db.Decimal(12, 2) // Tweede schijf tot
  incomeTaxBracket3 Decimal? @db.Decimal(12, 2) // Derde schijf tot
  
  // Algemene heffingskorting
  generalTaxCredit Decimal? @db.Decimal(10, 2)
  
  // Arbeidskorting
  employmentTaxCredit Decimal? @db.Decimal(10, 2)
  
  // Zelfstandigenaftrek
  selfEmployedDeduction Decimal? @db.Decimal(10, 2)
  
  // MKB-winstvrijstelling percentage
  smeProfitExemption Decimal? @db.Decimal(5, 2)
  
  // BTW aangifte frequentie
  vatFilingFrequency String @default("quarterly") // "monthly" | "quarterly" | "yearly"
  
  // Extra informatie (JSON voor flexibiliteit)
  additionalRules Json? // Voor toekomstige uitbreidingen
  
  // Metadata
  source          String? // Waar komen de regels vandaan (bijv. "belastingdienst", "manual")
  lastUpdated     DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("tax_rules")
}

model Subscription {
  id                String   @id @default(cuid())
  userId            String   @unique
  stripeCustomerId  String?  @unique
  stripeSubscriptionId String? @unique
  stripePriceId     String?
  plan              String   // "basis" | "premium" | "trial"
  status            String   // "active" | "canceled" | "past_due" | "trialing" | "incomplete" | "expired"
  isTrial           Boolean  @default(false) // Proefabonnement
  trialEndsAt       DateTime? // Wanneer proefperiode eindigt
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model IncomeTaxData {
  id              String   @id @default(cuid())
  companyId       String   @unique
  year            Int      // Jaar waarop deze gegevens van toepassing zijn
  
  // Persoonlijke situatie
  maritalStatus   String   @default("single") // "single" | "married" | "registered_partnership"
  
  // Andere inkomsten (niet uit onderneming)
  otherIncome     Decimal? @default(0) @db.Decimal(10, 2) // Loon, uitkering, etc.
  
  // Aftrekposten
  mortgageInterest Decimal? @default(0) @db.Decimal(10, 2) // Hypotheekrente
  healthcareCosts  Decimal? @default(0) @db.Decimal(10, 2) // Zorgkosten
  educationCosts  Decimal? @default(0) @db.Decimal(10, 2) // Studiekosten
  otherDeductions  Decimal? @default(0) @db.Decimal(10, 2) // Overige aftrekposten
  
  // Partner gegevens (indien van toepassing)
  partnerIncome   Decimal? @default(0) @db.Decimal(10, 2) // Inkomen partner
  
  // Extra informatie (JSON voor flexibiliteit)
  additionalData  Json? // Voor toekomstige uitbreidingen
  
  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("income_tax_data")
}

model TimeEntry {
  id          String   @id @default(cuid())
  companyId   String
  customerId  String
  date        DateTime
  hours       Decimal  @db.Decimal(5, 2) // Aantal uren (bijv. 7.5)
  description String?  // Optionele omschrijving van het werk
  hourlyRate  Decimal? @db.Decimal(10, 2) // Uurtarief (optioneel, kan ook per klant worden ingesteld)
  invoiceId   String?  // ID van factuur als deze uren al gefactureerd zijn
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([companyId, date])
  @@index([companyId, customerId])
  @@index([invoiceId])
  @@map("time_entries")
}

model MileageEntry {
  id              String   @id @default(cuid())
  companyId       String
  date            DateTime
  kilometers      Decimal  @db.Decimal(8, 2) // Aantal kilometers
  fromLocation    String?  // Vertrekpunt (optioneel)
  toLocation      String?  // Bestemming (optioneel)
  purpose         String?  // Doel van de reis (optioneel)
  ratePerKm       Decimal? @db.Decimal(5, 2) // Kilometervergoeding per km (bijv. 0.21 voor 21 cent)
  totalAmount     Decimal? @db.Decimal(10, 2) // Totaalbedrag (kilometers * ratePerKm)
  isBooked        Boolean  @default(false) // Of deze registratie al geboekt is
  bookingId       String?  // ID van de bijbehorende boeking (indien geboekt)
  createdBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, date])
  @@index([companyId, isBooked])
  @@map("mileage_entries")
}

model UserPreferences {
  id        String   @id @default(cuid())
  userId    String   @unique
  
  // Modules die zichtbaar zijn in de sidebar
  // Minimaal moeten deze altijd true zijn: uploads, timeEntries, invoices, mileage
  showUploads          Boolean @default(true)  // Bonnen/Documenten
  showTimeEntries      Boolean @default(true)  // Uren
  showInvoices         Boolean @default(true)  // Facturen
  showMileage          Boolean @default(true)  // Kilometers
  
  // Optionele modules
  showBookings         Boolean @default(false) // Boekingen
  showCustomers        Boolean @default(false) // Klanten
  showLedgerAccounts   Boolean @default(false)  // Grootboekrekeningen
  showBtw              Boolean @default(false)  // BTW
  showReports          Boolean @default(false) // Rapportages
  showRecurring        Boolean @default(false) // Herhalende Boekingen
  showTaxRules         Boolean @default(false) // Belastingregels
  showIncomeTax        Boolean @default(false) // Inkomstenbelasting
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}



